# ç½‘ç»œè¯·æ±‚æ¶æ„æ”¹è¿›æ€»ç»“

## æ”¹è¿›æ—¥æœŸ
2025-10-30

## é—®é¢˜æè¿°
åŸé¡¹ç›®çš„ç½‘ç»œè¯·æ±‚ç¼ºå°‘æ ‡å‡†åŒ–çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—ç³»ç»Ÿï¼Œå¯¼è‡´ï¼š
- å¼‚å¸¸æ²¡æœ‰åŸºæœ¬çš„å‰åå°æ—¥å¿—
- æ¯ä¸ª API ç«¯ç‚¹éƒ½é‡å¤ç¼–å†™ try-catch é€»è¾‘
- å‰ç«¯ fetch è°ƒç”¨ç¼ºå°‘ç»Ÿä¸€çš„é”™è¯¯å¤„ç†
- è°ƒè¯•å›°éš¾ï¼Œæ— æ³•è¿½è¸ªè¯·æ±‚å…¨é“¾è·¯

## æ”¹è¿›æ–¹æ¡ˆ

### 1. åç«¯ç»Ÿä¸€é”™è¯¯å¤„ç†å·¥å…·

**æ–‡ä»¶**: `lib/api-handler.ts`

åˆ›å»ºäº† `apiHandler` é«˜é˜¶å‡½æ•°ï¼Œæä¾›ï¼š
- âœ… ç»Ÿä¸€çš„é”™è¯¯æ•è·å’Œæ—¥å¿—è®°å½•
- âœ… æ ‡å‡†åŒ–çš„é”™è¯¯å“åº”æ ¼å¼
- âœ… è¯·æ±‚/å“åº”æ—¥å¿—ï¼ˆå¯é…ç½®ï¼‰
- âœ… æ€§èƒ½ç›‘æ§ï¼ˆè‡ªåŠ¨è®¡ç®—è€—æ—¶ï¼‰
- âœ… è¯·æ±‚ ID è¿½è¸ª

**ä½¿ç”¨ç¤ºä¾‹**:
```typescript
export default apiHandler({ name: 'Song-URL' }, async (req, res) => {
  const ids = validateParam(req.query.ids, 'ids', 'ç¼ºå°‘æ­Œæ›²IDåˆ—è¡¨')
  const result = await song_url_v1({ id: ids })
  res.status(200).json(result.body)
  return {} as any
})
```

**è¾…åŠ©å‡½æ•°**:
- `validateParam()` - å¿…éœ€å‚æ•°éªŒè¯
- `getOptionalParam()` - å¯é€‰å‚æ•°è·å–

### 2. å‰ç«¯ç»Ÿä¸€ç½‘ç»œè¯·æ±‚å°è£…

**æ–‡ä»¶**: `lib/api-client.ts`

åˆ›å»ºäº† `apiGet` å’Œ `apiPost` å‡½æ•°ï¼Œæä¾›ï¼š
- âœ… ç»Ÿä¸€çš„é”™è¯¯å¤„ç†
- âœ… è¯¦ç»†çš„è¯·æ±‚/å“åº”æ—¥å¿—ï¼ˆå¯é…ç½®ï¼‰
- âœ… è‡ªåŠ¨çš„ HTTP çŠ¶æ€ç æ£€æŸ¥
- âœ… ç±»å‹å®‰å…¨çš„å“åº”å¤„ç†
- âœ… è¯·æ±‚è¶…æ—¶æ§åˆ¶ï¼ˆé»˜è®¤30ç§’ï¼‰
- âœ… è‡ªå®šä¹‰é”™è¯¯ç±» `ApiError`

**ä½¿ç”¨ç¤ºä¾‹**:
```typescript
// GET è¯·æ±‚
const data = await apiGet('/api/auth/qr/key', { 
  name: 'QR-Key',
  logResponse: false 
})

// POST è¯·æ±‚
await apiPost('/api/auth/logout', undefined, { 
  name: 'Logout' 
})
```

**é”™è¯¯å¤„ç†è¾…åŠ©**:
```typescript
try {
  await apiGet('/api/data')
} catch (error) {
  alert(getErrorMessage(error, 'åŠ è½½æ•°æ®å¤±è´¥'))
}
```

## æ”¹é€ èŒƒå›´

### åç«¯ API ç«¯ç‚¹ï¼ˆ8ä¸ªæ–‡ä»¶ï¼‰
âœ… `pages/api/auth/qr/key.ts`
âœ… `pages/api/auth/qr/create.ts`
âœ… `pages/api/auth/qr/check.ts`
âœ… `pages/api/auth/status.ts`
âœ… `pages/api/auth/logout.ts`
âœ… `pages/api/song/url.ts`
âœ… `pages/api/playlist/detail.ts`
âœ… `pages/api/playlist/hot.ts`
âœ… `pages/api/search/playlist.ts`

### å‰ç«¯ç»„ä»¶ï¼ˆ3ä¸ªæ–‡ä»¶ï¼‰
âœ… `components/auth/QRLoginModal.tsx`
âœ… `components/FloatingLoginButton.tsx`
âœ… `pages/playlist/[id].tsx`

## æ—¥å¿—æ ¼å¼

### åç«¯æ—¥å¿—ç¤ºä¾‹
```
ğŸ”µ [QR-Key] è¯·æ±‚å¼€å§‹ [QR-Key-1730000000000-abc123]
   æ–¹æ³•: GET
   è·¯å¾„: /api/auth/qr/key
   Query: {}
âœ… [QR-Key] è¯·æ±‚æˆåŠŸ [QR-Key-1730000000000-abc123] - è€—æ—¶: 123ms
```

### å‰ç«¯æ—¥å¿—ç¤ºä¾‹
```
ğŸ”µ [APIè¯·æ±‚] QR-Key [1730000000000-xyz99]
   URL: /api/auth/qr/key
   æ–¹æ³•: GET
âœ… [APIæˆåŠŸ] QR-Key [1730000000000-xyz99] - è€—æ—¶: 145ms
   å“åº”: {"code":200,"data":{"unikey":"..."}}
```

## æ”¹è¿›æ•ˆæœ

### å¯ç»´æŠ¤æ€§æå‡
- **ä»£ç é‡å‡å°‘**: æ¯ä¸ª API ç«¯ç‚¹å¹³å‡å‡å°‘ 15-20 è¡Œé‡å¤ä»£ç 
- **ä¸€è‡´æ€§å¢å¼º**: æ‰€æœ‰æ¥å£éµå¾ªç»Ÿä¸€çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—æ ¼å¼
- **è°ƒè¯•æ•ˆç‡**: é€šè¿‡è¯·æ±‚ ID å¯è¿½è¸ªå®Œæ•´è¯·æ±‚é“¾è·¯

### å¯è§‚æµ‹æ€§æå‡
- **å‰ç«¯æ—¥å¿—**: æµè§ˆå™¨æ§åˆ¶å°è‡ªåŠ¨è®°å½•æ‰€æœ‰è¯·æ±‚ç»†èŠ‚
- **åç«¯æ—¥å¿—**: æœåŠ¡å™¨ç»ˆç«¯è¾“å‡ºç»“æ„åŒ–æ—¥å¿—
- **æ€§èƒ½ç›‘æ§**: è‡ªåŠ¨è®°å½•æ¯ä¸ªè¯·æ±‚çš„è€—æ—¶

### ç”¨æˆ·ä½“éªŒæå‡
- **å‹å¥½é”™è¯¯æç¤º**: ä½¿ç”¨ `getErrorMessage()` æä¾›æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯
- **è¶…æ—¶æ§åˆ¶**: é¿å…è¯·æ±‚æ— é™ç­‰å¾…
- **çŠ¶æ€è¿½è¸ª**: æ›´å‡†ç¡®çš„åŠ è½½çŠ¶æ€åé¦ˆ

## æœ€ä½³å®è·µ

### 1. API ç«¯ç‚¹å¼€å‘
```typescript
// âœ… æ¨è
export default apiHandler(
  { name: 'APIåç§°', logResponse: false }, // å¤§å“åº”ä½“å¯å…³é—­æ—¥å¿—
  async (req, res) => {
    const id = validateParam(req.query.id, 'id')
    const data = await fetchData(id)
    res.status(200).json(data)
    return {} as any
  }
)

// âŒ é¿å…
export default async function handler(req, res) {
  try {
    // æ‰‹åŠ¨ try-catch
  } catch (e) {
    // æ‰‹åŠ¨é”™è¯¯å¤„ç†
  }
}
```

### 2. å‰ç«¯è¯·æ±‚
```typescript
// âœ… æ¨è
try {
  const data = await apiGet('/api/endpoint', { 
    name: 'æè¿°æ€§åç§°',
    logResponse: false // é¢‘ç¹è½®è¯¢å¯å…³é—­æ—¥å¿—
  })
} catch (error) {
  setError(getErrorMessage(error, 'é»˜è®¤æç¤º'))
}

// âŒ é¿å…
try {
  const res = await fetch('/api/endpoint')
  if (!res.ok) throw new Error(...)
  const data = await res.json()
} catch (e) {
  // æ‰‹åŠ¨å¤„ç†
}
```

### 3. æ—¥å¿—çº§åˆ«æ§åˆ¶
```typescript
// è½®è¯¢è¯·æ±‚ï¼šå…³é—­æ—¥å¿—é¿å…åˆ·å±
await apiGet('/api/auth/qr/check', { 
  logRequest: false,
  logResponse: false
})

// å¤§æ•°æ®è¯·æ±‚ï¼šå…³é—­å“åº”æ—¥å¿—
await apiGet('/api/playlist/detail', { 
  logResponse: false
})

// è°ƒè¯•é˜¶æ®µï¼šå¼€å¯æ‰€æœ‰æ—¥å¿—
await apiGet('/api/debug', { 
  logRequest: true,
  logResponse: true
})
```

## æ³¨æ„äº‹é¡¹

1. **ä¸è¦çŒœæµ‹å’Œå‡è®¾**ï¼šæ‰€æœ‰ç½‘ç»œè¯·æ±‚å¿…é¡»æœ‰æ˜ç¡®çš„é”™è¯¯å¤„ç†
2. **æ—¥å¿—åˆç†æ€§**ï¼šé¢‘ç¹è¯·æ±‚åº”å…³é—­æ—¥å¿—ï¼Œé¿å…æ€§èƒ½å½±å“
3. **é”™è¯¯ä¿¡æ¯**ï¼šä½¿ç”¨ `getErrorMessage()` æä¾›ç”¨æˆ·å‹å¥½çš„é”™è¯¯æç¤º
4. **è¶…æ—¶è®¾ç½®**ï¼šæ ¹æ®æ¥å£ç‰¹æ€§è°ƒæ•´ timeout å‚æ•°

## å…¼å®¹æ€§

- âœ… Next.js 16.0+
- âœ… TypeScript 5.9+
- âœ… Node.js 18+
- âœ… æµè§ˆå™¨ï¼šChrome/Firefox/Safari æœ€æ–°ç‰ˆ

## åç»­ä¼˜åŒ–å»ºè®®

1. **æ—¥å¿—æŒä¹…åŒ–**: è€ƒè™‘æ¥å…¥ Sentry æˆ–å…¶ä»–æ—¥å¿—æœåŠ¡
2. **æ€§èƒ½åˆ†æ**: åŸºäºè€—æ—¶æ•°æ®ä¼˜åŒ–æ…¢æ¥å£
3. **é‡è¯•æœºåˆ¶**: å¯¹ç½‘ç»œä¸ç¨³å®šçš„æ¥å£æ·»åŠ è‡ªåŠ¨é‡è¯•
4. **è¯·æ±‚ç¼“å­˜**: å¯¹ä¸å¸¸å˜åŒ–çš„æ•°æ®æ·»åŠ ç¼“å­˜å±‚

---

**æ”¹è¿›å®Œæˆ**: æ•´ä¸ªé¡¹ç›®çš„ç½‘ç»œè¯·æ±‚ç°åœ¨å…·å¤‡æ ‡å‡†åŒ–çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—ç³»ç»Ÿï¼Œè°ƒè¯•æ•ˆç‡å’Œä»£ç å¯ç»´æŠ¤æ€§æ˜¾è‘—æå‡ã€‚


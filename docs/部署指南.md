# Vercel 部署指南

## 前置准备

1. 安装依赖：
```bash
npm install
```

2. 本地测试：
```bash
npm run dev
```
访问 http://localhost:3000 确认页面正常

3. 检查配置文件：
- ✅ `vercel.json` - Vercel 部署配置
- ✅ `.vercelignore` - 排除不需要部署的文件
- ✅ `next.config.js` - Next.js 配置

## 配置文件说明

### vercel.json
```json
{
  "version": 2,
  "functions": {
    "pages/api/**/*.ts": {
      "maxDuration": 30  // API 超时时间 30 秒
    }
  },
  "regions": ["hkg1", "sfo1"],  // 部署区域：香港 + 旧金山
  ...
}
```

**关键配置**：
- **maxDuration**: API 超时时间（免费版最大 10s，Pro 版最大 60s）
- **regions**: 部署区域，优先选择离用户近的节点
- **headers**: 安全头部、CORS 配置、缓存策略
- **rewrites**: sitemap.xml 和 robots.txt 路由重写

### .vercelignore
排除不需要部署的文件：
- 开发依赖（node_modules）
- 构建产物（.next）
- 文档文件（*.md）
- 旧版服务器（server.js）

## 部署到 Vercel

### 方式一：通过 Vercel CLI（推荐）

1. 安装 Vercel CLI：
```bash
npm i -g vercel
```

2. 登录并部署：
```bash
vercel login
vercel
```

3. 按提示选择项目设置，首次部署会自动检测 Next.js 框架

### 方式二：通过 Vercel Dashboard

1. 访问 [Vercel Dashboard](https://vercel.com/dashboard)
2. 点击"Import Project"
3. 连接 GitHub/GitLab/Bitbucket 仓库
4. 选择本项目仓库
5. Vercel 会自动检测 Next.js 并配置构建命令：
   - Build Command: `npm run build`
   - Output Directory: `.next`
6. 点击"Deploy"

## 环境变量配置（可选）

如果需要配置环境变量，在 Vercel Dashboard → Settings → Environment Variables 添加：

```
NEXT_PUBLIC_BASE_URL=https://your-domain.vercel.app
```

## 自定义域名

1. 在 Vercel Dashboard → Settings → Domains
2. 添加自定义域名
3. 按提示配置 DNS 记录（CNAME 或 A 记录）

## 部署后检查清单

- [ ] 访问首页确认 GTM 加载（查看浏览器控制台 Network）
- [ ] 测试搜索功能：`/search/周杰伦`
- [ ] 测试歌单详情：`/playlist/123456`
- [ ] 访问 `/sitemap.xml` 确认输出正常
- [ ] 访问 `/robots.txt` 确认输出正常
- [ ] 访问 `/docs/guide` 和 `/docs/quality` 确认文档页正常
- [ ] 在 Google Search Console 提交 sitemap
- [ ] 在 GTM 中配置 GA4 并测试事件（page_view、search_submit、playlist_view）

## 性能优化建议

1. 启用 Vercel Analytics（免费）
2. 配置 ISR revalidate 时间（已在代码中预留）
3. 使用 `next/image` 优化图片加载
4. 启用 Vercel Edge Network 加速全球访问

## 注意事项

### API 超时配置
- **免费版**：函数最大执行时间 10 秒
- **Pro 版**：函数最大执行时间 60 秒
- 当前配置 30 秒（需 Pro 版），如使用免费版请修改为 10 秒：
  ```json
  {
    "functions": {
      "pages/api/**/*.ts": {
        "maxDuration": 10
      }
    }
  }
  ```

### 部署区域选择
当前配置：`["hkg1", "sfo1"]`（香港 + 旧金山）
- **国内用户**：优先 hkg1（香港）
- **海外用户**：优先 sfo1（旧金山）
- **全球部署**：可添加更多区域（需 Pro 版）

### 环境变量（可选）
如需配置环境变量，在 Vercel Dashboard → Settings → Environment Variables 添加：
```
NEXT_PUBLIC_SITE_URL=https://your-domain.vercel.app
```

## 故障排查

### API 调用失败
- 检查 `pages/api/*` 是否正确导入 `NeteaseCloudMusicApi`
- 查看 Vercel Functions 日志
- 确认 API 超时时间配置（免费版 10s，Pro 版 60s）

### 页面 404
- 确认 `pages/` 目录结构正确
- 检查 Next.js 构建日志
- 确认路由配置正确（动态路由使用 `[id].tsx` 格式）

### GTM 未加载
- 确认容器 ID `GTM-5GDR9Z8Z` 正确
- 检查浏览器控制台是否有跨域错误
- 检查 `pages/_document.tsx` 中的 GTM 代码

### sitemap/robots.txt 无法访问
- 确认 `vercel.json` 中的 rewrites 配置正确
- 检查 `pages/api/sitemap.xml.ts` 和 `pages/api/robots.txt.ts` 文件存在
- 清除浏览器缓存后重试

